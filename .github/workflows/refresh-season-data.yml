name: Refresh current season data

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season to refresh (defaults to current season)"
        required: false
      include_playoffs:
        description: "Include postseason plays"
        required: false
        default: "true"
        type: boolean
  schedule:
    # 11:30 UTC on Monday, Tuesday, and Friday
    - cron: "30 11 * * 1,2,5"

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Restore cached database (latest)
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: nflstats.db
          key: nflstats-db-${{ github.run_id }}
          restore-keys: |
            nflstats-db-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine season to fetch
        id: season
        run: |
          override='${{ inputs.season }}'
          if [ -n "$override" ]; then
            season=$override
          else
            current_year=$(date -u +%Y)
            current_month=$(date -u +%m)
            if [ "$current_month" -lt 3 ]; then
              season=$((current_year - 1))
            else
              season=$current_year
            fi
          fi
          echo "season=$season" >> "$GITHUB_OUTPUT"
          echo "Refreshing season $season"

      - name: Refresh EPA snapshots for the season
        run: |
          args="--season ${{ steps.season.outputs.season }}"
          if [ "${{ inputs.include_playoffs }}" = "true" ]; then
            args="$args --include-playoffs"
          fi
          python -m scripts.fetch_epa $args

      - name: Save updated database cache
        uses: actions/cache/save@v4
        with:
          path: nflstats.db
          key: nflstats-db-${{ github.run_id }}

      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: nflstats-db
          path: nflstats.db
