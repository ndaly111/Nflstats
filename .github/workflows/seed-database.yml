name: Seed database

on:
  workflow_dispatch:
    inputs:
      season_start:
        description: "First season year to backfill"
        required: true
        default: "1999"
      season_end:
        description: "Last season year to backfill (defaults to current season)"
        required: false
      include_playoffs:
        description: "Include postseason plays when backfilling"
        required: false
        default: "true"
        type: boolean

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Restore cached database (latest)
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: nflstats.db
          key: nflstats-db-${{ github.run_id }}
          restore-keys: |
            nflstats-db-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Resolve season range
        id: seasons
        run: |
          start=${{ inputs.season_start }}
          end_input='${{ inputs.season_end }}'
          current_year=$(date -u +%Y)
          current_month=$(date -u +%m)
          if [ -n "$end_input" ]; then
            end=$end_input
          elif [ "$current_month" -lt 3 ]; then
            end=$((current_year - 1))
          else
            end=$current_year
          fi

          if [ "$start" -gt "$end" ]; then
            echo "Start season $start cannot exceed end season $end" >&2
            exit 1
          fi

          echo "start=$start" >> "$GITHUB_OUTPUT"
          echo "end=$end" >> "$GITHUB_OUTPUT"
          echo "Backfilling seasons $start through $end"

      - name: Build historical EPA snapshots
        run: |
          for season in $(seq ${{ steps.seasons.outputs.start }} ${{ steps.seasons.outputs.end }}); do
            echo "Processing season $season"
            args="--season $season"
            if [ "${{ inputs.include_playoffs }}" = "true" ]; then
              args="$args --include-playoffs"
            fi
            python -m scripts.fetch_epa $args
          done

      - name: Save updated database cache
        uses: actions/cache/save@v4
        with:
          path: nflstats.db
          key: nflstats-db-${{ github.run_id }}

      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: nflstats-db
          path: nflstats.db
