name: Update EPA data

on:
  schedule:
    - cron: '0 12 * * 2'
  workflow_dispatch:
    inputs: {}  # no manual inputs needed

concurrency:
  group: epa-data
  cancel-in-progress: false

permissions:
  contents: write

env:
  # Always start backfilling from the year 2000
  SEASON_START: "2000"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Sync to latest branch HEAD
        run: |
          set -euo pipefail
          branch="${GITHUB_REF_NAME}"
          git fetch origin "$branch"
          git checkout -B "$branch" "origin/$branch"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Determine season target
        id: season
        run: |
          set -euo pipefail
          SEASON_START="${{ env.SEASON_START }}"

          current_year="$(date -u '+%Y')"
          current_month="$(date -u '+%m')"
          if [ "$current_month" -ge 9 ]; then
            current_season="$current_year"
          else
            current_season=$((current_year - 1))
          fi

          # Always backfill from SEASON_START to current season
          season_start="$SEASON_START"
          season_end="$current_season"
          season="$season_end"
          echo "mode=backfill_range" >> "$GITHUB_OUTPUT"
          echo "season=$season" >> "$GITHUB_OUTPUT"
          echo "season_start=$season_start" >> "$GITHUB_OUTPUT"
          echo "season_end=$season_end" >> "$GITHUB_OUTPUT"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Refresh SQLite cache
        if: false  # disable single-season refresh; always use range
        run: echo "Single-season refresh disabled"
          
      - name: Refresh SQLite cache (range)
        # Always backfill from start to end
        run: |
          set -euo pipefail
          start=${{ steps.season.outputs.season_start }}
          end=${{ steps.season.outputs.season_end }}
          for season in $(seq $start $end); do
            echo "Backfilling season $season"
            python -m scripts.fetch_epa --season $season --db data/epa.sqlite --include-playoffs
            python -c "import sqlite3; conn=sqlite3.connect('data/epa.sqlite'); conn.execute('PRAGMA wal_checkpoint(TRUNCATE);'); conn.close()"
            rm -f data/epa.sqlite-wal data/epa.sqlite-shm
          done

      - name: Export static JSON
        run: |
          python -m scripts.export_epa_json --db data/epa.sqlite --output data/epa.json

      - name: Validate exported payload
        run: |
          # Validate that every season has at least 28 teams
          SEASON_START=${{ steps.season.outputs.season_start }}
          SEASON_END=${{ steps.season.outputs.season_end }}
          python - <<'PY'
import json
import os
from pathlib import Path

payload = json.loads(Path('data/epa.json').read_text())
seasons = payload.get('seasons', {})
if not seasons:
    raise SystemExit('No seasons found in exported JSON')
start = int(os.environ['SEASON_START'])
end = int(os.environ['SEASON_END'])
missing = []
for year in range(start, end + 1):
    key = str(year)
    if key not in seasons:
        missing.append(key)
    else:
        teams = len(seasons[key].get('teams', []))
        if teams < 28:
            raise SystemExit(f'Season {key} has only {teams} teams')
if missing:
    raise SystemExit(f'Missing seasons: {", ".join(missing)}')
print('Validated all seasons')
PY

      - name: Final checkpoint before commit
        run: |
          set -euo pipefail
          python -c "import sqlite3; conn=sqlite3.connect('data/epa.sqlite'); conn.execute('PRAGMA wal_checkpoint(TRUNCATE);'); conn.close()"
          rm -f data/epa.sqlite-wal data/epa.sqlite-shm

      - name: Commit and push updates
        run: |
          git add data/epa.sqlite data/epa.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          season_start="${{ steps.season.outputs.season_start }}"
          season_end="${{ steps.season.outputs.season_end }}"
          git commit -m "chore: refresh all seasons ${season_start}-${season_end}"
          branch="${GITHUB_REF_NAME}"
          git push origin HEAD:"$branch"
